# 2D version of the model with simplified viscosity. 
# This setup is useful for testing if the equation of
# state works properly.  

set Additional shared libraries            = ../../plugins/libequilibrium_grain_size.so

set Dimension = 2
set Use years in output instead of seconds = true
set Output directory                       = TM1-and-tomography
set Nonlinear solver scheme                = iterated Advection and Stokes
set Start time                             = 0
set End time                               = 0
set Adiabatic surface temperature          = 1573.0


subsection Solver parameters
  subsection Stokes solver parameters
   set Linear solver tolerance                         = 1e-4
   set Stokes solver type                              = block GMG
   set Number of cheap Stokes solver steps             = 5000
   set GMRES solver restart length                     = 1000
   set Maximum number of expensive Stokes solver steps = 0
   set Use full A block as preconditioner              = true
   set Linear solver A block tolerance                 = 1e-2
  end
end

subsection Adiabatic conditions model
  set Model name = reference profile

  subsection Reference profile
    subsection Ascii data model
      set Data directory = ../../input_data/1D_reference_profiles/
      set Data file name = prem.txt
    end
  end
end

subsection Geometry model
  set Model name = spherical shell

  subsection Spherical shell
    set Inner radius  = 3481000
    set Outer radius  = 6336000
  end
end


subsection Mesh refinement
  set Initial adaptive refinement = 0
  set Initial global refinement = 7
  set Strategy = minimum refinement function
  set Skip solvers on initial refinement = true
  
  subsection Minimum refinement function
    set Variable names = depth, y
    set Function expression = if (depth > 500000 && depth < 800000, 10, 7)
  end
end


subsection Compositional fields
  set Number of fields = 5
  set Names of fields = grain_size, Vp, Vs, vs_anomaly, faults
  set Compositional field methods = static, static, static, static, static
end


subsection Initial composition model
  set List of model names = ascii data slice

  subsection Ascii data model
    set Data directory = ../../input_data/
    set Data file name = LLNL_velocity_model_wb.txt
  end
end


subsection Boundary velocity model
  set Tangential velocity boundary indicators = bottom, top
end


subsection Nullspace removal
  set Remove nullspace = net surface rotation
end


subsection Boundary temperature model
  set Fixed temperature boundary indicators   = top, bottom
  set List of model names = spherical constant
  subsection Spherical constant
    set Inner temperature = 3700
    set Outer temperature = 273
  end
end


subsection Initial temperature model
  set List of model names = ascii data, adiabatic boundary
  set List of model operators = maximum

  subsection Ascii data model
    set Data directory = ../../input_data/
    set Data file name = upper_mantle_TM1_2D.txt
  end
  
  subsection Adiabatic boundary 
    set Data directory = ../../input_data/
    set Data file name = LAB_CAM2016_2D.txt
    set Adiabatic temperature gradient = 0
    set Isotherm temperature = 274
    set Surface temperature = 273
  end
end

subsection Temperature field
  set Temperature method = prescribed field
end

subsection Heating model
  set List of model names = adiabatic heating, shear heating
end


subsection Gravity model
  set Model name = ascii data
end


subsection Material model
  set Model name         = equilibrium grain size
  set Material averaging = harmonic average only viscosity

  subsection Equilibrium grain size model   
    set Minimum viscosity                           = 1e23
    set Maximum viscosity                           = 1e23
    set Reference specific heat                     = 1200
    set Uppermost mantle thickness                  = 300000

   set Use depth dependent density scaling         = true

   subsection Ascii data model
     set Data directory                            = ../../input_data/
     set Data file name                            = steinberger_source.txt 
   end

   subsection Density velocity scaling
     set Data directory                            = ../../input_data/
     set Data file name                            = depth_rho_vs_tutu.txt
   end
   
   subsection Thermal expansivity profile
     set Data directory                            = ../../input_data/
     set Data file name                            = thermal_expansivity_steinberger_calderwood.txt
   end
   
   subsection Crustal depths
     set Data directory                            = ../../input_data/
     set Data file name                            = crustal_structure_2D.txt
   end
  end
end


subsection Formulation
  set Mass conservation = reference density profile
end


subsection Postprocess
  set List of postprocessors         = velocity statistics, visualization
  
  subsection Visualization
    set List of output variables      = adiabat, material properties, gravity, nonadiabatic temperature, nonadiabatic pressure
    set Output format  = vtu  
  end
end
